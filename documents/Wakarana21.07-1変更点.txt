【 Wakarana 21.01-1での変更点 】

< 新規クラス >
wakarana_common (新規ファイルcommon.phpに収録)
　■wakaranaとwakarana_configはこのクラスを継承するものとする
　■宣言「private $config」と「private $db_obj」はこのクラスに集約


< 新規変数 >
wakarana_common::last_error_text
　privateで宣言
　最も新しいエラーのエラー文が入る


< 新規定数 >
WAKARANA_MAIL_PURPOSE_NEW_USER = 0
　main.phpで定義
　メールアドレス認証トークンが新規ユーザー登録用に発行されることを表す

WAKARANA_MAIL_PURPOSE_EXISTING_USER = 1
　main.phpで定義
　メールアドレス認証トークンが登録済みユーザー用に発行されることを表す

WAKARANA_CONFIG_ORIGINAL = array(<略>)
　config.phpで定義
　config.iniのデフォルト値を連想配列で格納


< 新規関数 >
wakarana_common::connect_db()
　DB接続インスタンスを生成して$db_objに格納する。
　■wakarana::__construct()とwakarana_config::setup_db()はこの関数を呼び出すよう変更

wakarana_common::print_error($error_text)
　エラー文を出力し、$last_error_textにもその文を代入する。
　config.iniのdisplay_errorsがFALSEの場合は$last_error_textへの代入だけで出力はしない。
　■wakaranaにおけるエラーの出力処理は全てこの関数に置き換え
　■同時に、add_userとchange_user_dataのメールアドレス重複時やset_login_tokenのcookie送信失敗時などのこれまでエラー文を出力していなかった処理にもエラー文導入

wakarana_common::get_last_error_text()
　wakaranaで発生した最も新しいエラーのエラー文を取得する。
　内部的にはlast_error_textをreturnするだけ。

wakarana::create_mail_confirmation_token($mail_address, $user_id = NULL)
　メールアドレス所有者確認メール用のトークンを発行し、これをデータベースに登録する。
　$user_idを省略したときは新規ユーザー登録前の確認目的とみなす。
　データベースに古いトークンがあれば自動で削除する。

wakarana::mail_confirm($token, $delete_token = TRUE)
　メールアドレス所有者確認メール用のトークンをチェックし、有効なトークンならそのトークンの発行目的(新規ユーザー用、登録済みユーザー用)の数値とユーザーID、メールアドレスが格納された配列を返す。存在しない場合とエラーの場合はFALSEを返す。
　$delete_tokenがTRUEの場合、チェック済みのトークンはデータベースから削除される。

wakarana::save_user_mail_address($token)
　メールアドレス所有者確認メール用のトークンをチェックし、登録済みユーザー用の有効なトークンなら、wakarana_usersのそのユーザーのレコードのメールアドレスを変更する。
　使用済みのトークンはデータベースから削除される。

wakarana::delete_old_one_time_tokens($expire = -1)
　有効期限を超過したワンタイムトークンを削除する。
　■create_one_time_tokenは内部でこれを呼ぶように修正

wakarana::delete_old_attempt_logs($expire = -1)
　保存期限を超過したログイン試行ログを削除する。
　■add_attempt_logsは内部でこれを呼ぶように修正

wakarana::delete_old_mail_confirmation_tokens($expire = -1)
　有効期限を超過したメール認証トークンを削除する。

wakarana::delete_old_totp_temporary_tokens($expire = -1)
　有効期限を超過したTOTP認証待ち仮トークンを削除する。
　■create_totp_temporary_tokenの内部処理にこれを追加

wakarana::generate_random_password()
　16文字のランダムなパスワードを生成して返す。
　
wakarana_config::set_config_value($key, $value, $save_now = TRUE)
　config.iniの特定の値を書き換える。$save_now=FALSEのときはセーブしない。(一度に復数変更するときのオーバーヘッド低減)
　成功した場合はTRUE、型が不正なときや存在しないkeyの場合はFALSEを返す。
　■これに伴い、set_use_sqlite、set_sqlite_db_file、configure_mysql、set_allow_mail_duplication、set_confirmation_mail_expire、configure_login_token、configure_one_time_token、configure_attempt、configure_totpは削除

wakarana_config::reset_config()
　config.iniを全てデフォルト値に戻す。
　■これに伴い、saveの$initializationは削除

その他
　■delete_old_login_tokensの引数をdelete_old_one_time_tokensなどと同様「$expire = -1」に変更

< 設定ファイル変更点 >
display_errors
　エラー文を出力するかどうか
